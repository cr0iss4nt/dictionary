{% extends "base.html" %}

{% block title %}Слова{% endblock %}

{% block content %}

<input type="file" id="fileInput" accept=".txt,.rtf" style="display: none;">

<a href="#" onclick="openFileDialog()" class="btn btn-sm btn-success">
    Заполнить
</a>

<a href="#" onclick="exportDictionary()" class="btn btn-sm btn-primary">
    Экспортировать
</a>

<a href="{{ url_for('clear') }}" class="btn btn-sm btn-danger"
   onclick="return confirm('Очистить словарь?')">
    Очистить
</a>

<script>
function openFileDialog() {
    document.getElementById('fileInput').click();
}

function exportDictionary() {
    // show loading state
    const exportBtn = document.querySelector('a[onclick="exportDictionary()"]');
    const originalText = exportBtn.textContent;
    exportBtn.textContent = 'Экспорт...';
    exportBtn.classList.remove('btn-primary');
    exportBtn.classList.add('btn-secondary');
    exportBtn.style.pointerEvents = 'none';

    // send request to server
    fetch('/export', {
        method: 'GET'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Export failed');
        }

        // get filename or use default
        const contentDisposition = response.headers.get('Content-Disposition');
        let filename = 'dictionary.txt';
        if (contentDisposition) {
            const match = contentDisposition.match(/filename=(.+)/);
            if (match) {
                filename = match[1];
            }
        }

        return response.blob().then(blob => ({ blob, filename }));
    })
    .then(({ blob, filename }) => {
        // create download link
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();

        // cleanup
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);

        // restore button state
        exportBtn.textContent = originalText;
        exportBtn.classList.add('btn-primary');
        exportBtn.classList.remove('btn-secondary');
        exportBtn.style.pointerEvents = 'auto';
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ошибка при экспорте словаря');
        exportBtn.textContent = originalText;
        exportBtn.classList.add('btn-primary');
        exportBtn.classList.remove('btn-secondary');
        exportBtn.style.pointerEvents = 'auto';
    });
}

// select file
document.getElementById('fileInput').addEventListener('change', function(e) {
    if (this.files.length === 0) return;

    const file = this.files[0];
    const formData = new FormData();
    formData.append('file', file);

    // loading state
    const btn = document.querySelector('a[onclick="openFileDialog()"]');
    const originalText = btn.textContent;
    btn.textContent = 'Обработка...';
    btn.classList.remove('btn-success');
    btn.classList.add('btn-secondary');
    btn.style.pointerEvents = 'none';

    // send to server
    fetch('/fill', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.redirected) {
            window.location.href = response.url;
        } else if (response.ok) {
            window.location.reload();
        } else {
            throw new Error('Upload failed');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ошибка при загрузке файла');
        btn.textContent = originalText;
        btn.classList.add('btn-success');
        btn.classList.remove('btn-secondary');
        btn.style.pointerEvents = 'auto';
    });

    // reset file input
    this.value = '';
});
</script>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Слово</th>
                        <th>Часть речи</th>
                        <th>Основа</th>
                        <th>Окончание</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for word in words %}
                    <tr>
                        <td>{{ word[0] }}</td>
                        <td>{{ word[1] }}</td>
                        <td>{{ word[2] }}</td>
                        <td>{{ word[3] }}</td>
                        <td>{{ word[4] }}</td>
                        <td>
                            <a href="{{ url_for('add_base_and_ending', word=word[1]) }}" class="btn btn-sm btn-info"
                               onclick="return confirm('Разобрать слово по составу?')">
                                Разобрать
                            </a>
                            {% if word[2] in ['NOUN', 'ADJF', 'INFN'] %}
                            <a href="{{ url_for('make_word_form', word=word[1]) }}" class="btn btn-sm btn-info">
                                Сделать словоформу
                            </a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>


{% endblock %}